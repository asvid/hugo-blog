{{- $cover := false -}}
{{- $optimizedCover := false -}}
{{- $autoCover := default $.Site.Params.autoCover false }}

{{- if index .Params "cover" -}}
  {{- if .Resources.GetMatch .Params.Cover }}
    {{- $cover = (.Resources.GetMatch .Params.Cover).RelPermalink -}}
  {{- else -}}
    {{- $cover = absURL .Params.Cover -}}
  {{- end -}}
{{- else if index .Params "image" -}}
  {{- $imagePath := .Params.image -}}
  {{- $imagePath = strings.TrimPrefix "/assets/" $imagePath -}}
  {{- $imagePath = strings.TrimPrefix "assets/" $imagePath -}}
  {{- $imagePath = strings.TrimPrefix "/" $imagePath -}}
  
  {{- $image := resources.Get $imagePath -}}
  {{- if $image -}}
    <!-- Hugo processed image with optimization -->
    {{- $resized := $image.Resize "800x q85" -}}
    {{- $webp := $image.Resize "800x webp q85" -}}
    {{- $optimizedCover = dict "resized" $resized "webp" $webp -}}
  {{- else if .Resources.GetMatch .Params.image }}
    {{- $cover = (.Resources.GetMatch .Params.image).RelPermalink -}}
  {{- else -}}
    {{- $cover = absURL .Params.image -}}
  {{- end -}}
{{- else if $.Site.Params.AutoCover -}}
  {{- if (not .Params.Cover) -}}
    {{- if .Resources.GetMatch "cover.*" -}}
      {{- $cover = (.Resources.GetMatch "cover.*").RelPermalink -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $optimizedCover -}}
  <!-- Optimized image with WebP support -->
  <picture class="post-cover-picture">
    <source srcset="{{ $optimizedCover.webp.RelPermalink }}" type="image/webp">
    <img src="{{ $optimizedCover.resized.RelPermalink }}"
         class="post-cover"
         alt="{{ .Title | plainify | default " " }}"
         loading="lazy"
         width="{{ $optimizedCover.resized.Width }}"
         height="{{ $optimizedCover.resized.Height }}"
         title="{{ .Params.CoverCredit | plainify | default "Cover Image" }}" />
  </picture>
{{- else if $cover -}}
  <!-- Fallback for non-processed images -->
  <img src="{{ $cover }}"
       class="post-cover"
       alt="{{ .Title | plainify | default " " }}"
       loading="lazy"
       title="{{ .Params.CoverCredit | plainify | default "Cover Image" }}" />
{{- end -}}