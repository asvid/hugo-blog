<!-- Performance optimizations for Core Web Vitals -->

<!-- Preconnect to external domains -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net">

<!-- DNS prefetch for external resources -->
<link rel="dns-prefetch" href="//github.com">
<link rel="dns-prefetch" href="//linkedin.com">
<link rel="dns-prefetch" href="//youtube.com">
<link rel="dns-prefetch" href="//twitch.tv">

<!-- Resource hints for critical resources -->
<link rel="preload" href="{{ "style.css" | absURL }}" as="style">
<link rel="preload" href="{{ "bundle.min.js" | absURL }}" as="script">

{{- if .Store.Get "hasMermaid" }}
<link rel="preload" href="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs" as="script">
{{- end }}

<!-- Optimize images with modern formats and responsive loading -->
{{- $image := .Params.image | default .Site.Params.og_image -}}
{{- if $image }}
{{- $imageResource := resources.Get $image -}}
{{- if $imageResource }}
{{- $resized := $imageResource.Resize "1200x webp" -}}
{{- $resizedSmall := $imageResource.Resize "600x webp" -}}
<link rel="preload" href="{{ $resized.RelPermalink }}" as="image">
{{- end }}
{{- end }}

<!-- Critical CSS inlining -->
<style>
  /* Critical above-the-fold styles */
  .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
  .content { line-height: 1.6; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

  /* Prevent layout shift */
  .mermaid { min-height: 200px; background: #f8f9fa; border-radius: 4px; }

  /* Loading states */
  img { loading: lazy; }
</style>

<!-- Defer non-critical JavaScript -->
<script>
  // Defer loading of non-critical JS
  function loadDeferredScripts() {
    const scripts = [
      {{ if .Store.Get "hasMermaid" }}
      'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs',
      {{ end }}
    ];

    scripts.forEach(src => {
      if (!document.querySelector(`script[src="${src}"]`)) {
        const script = document.createElement('script');
        script.src = src;
        script.type = 'module';
        document.head.appendChild(script);
      }
    });
  }

  // Run after initial page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadDeferredScripts);
  } else {
    loadDeferredScripts();
  }

  // Preload next page content
  function prefetchNextPage() {
    const nextLink = document.querySelector('a[rel="next"]');
    if (nextLink) {
      const link = document.createElement('link');
      link.rel = 'prefetch';
      link.href = nextLink.href;
      document.head.appendChild(link);
    }
  }

  // Run prefetching after page load
  window.addEventListener('load', prefetchNextPage);
</script>

<!-- Service Worker registration for offline capability -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/sw.js').then(function(registration) {
        console.log('ServiceWorker registration successful');
      }).catch(function(err) {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>